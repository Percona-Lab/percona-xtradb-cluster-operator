#!/bin/bash

set -o errexit
set -o xtrace

test_dir=$(realpath $(dirname $0))
. ${test_dir}/../functions
cluster="auto-tuning"


create_namespace $namespace
deploy_operator

spinup_pxc "$cluster" "$test_dir/conf/$cluster.yml"

AUTO_INNODB_SIZE=$(run_mysql \
                        'SELECT @@innodb_buffer_pool_size;' \
                        "-h $cluster-pxc -uroot -proot_password")
AUTO_CONNECTIONS=$(run_mysql \
                        'SELECT @@max_connections;' \
                        "-h $cluster-pxc -uroot -proot_password")

kubectl_bin patch pxc "${cluster}" --type merge -p'{"spec": {"pxc": {"configuration": "[mysqld]\ninnodb_buffer_pool_size=150000000\nmax_connections=200\n"}}}'


wait_cluster_consistency "${cluster}" 3
sleep 20
wait_cluster_consistency "${cluster}" 3
sleep 20
wait_cluster_consistency "${cluster}" 3
sleep 20

INNODB_SIZE=$(run_mysql \
                        'SELECT @@innodb_buffer_pool_size;' \
                        "-h $cluster-pxc -uroot -proot_password")
CONNECTIONS=$(run_mysql \
                        'SELECT @@max_connections;' \
                        "-h $cluster-pxc -uroot -proot_password")

if [[ ${AUTO_INNODB_SIZE} == ${INNODB_SIZE} ]]; then
    echo "Automatic innodb_buffer_pool_size has not been set"
    exit 1
fi

if [[ ${AUTO_CONNECTIONS} == ${CONNECTIONS} ]]; then
    echo "Automatic max_connections has not been set"
    exit 1
fi

destroy $namespace
